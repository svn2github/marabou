dnl Process this file with autoconf to produce a configure script.
AC_INIT(syslog.c)
AC_CONFIG_AUX_DIR(config)
AM_INIT_AUTOMAKE(compat, 0.5)
AM_MAINTAINER_MODE

dnl Checks for programs.
AC_PROG_CC
AM_PROG_CC_STDC
AC_PROG_RANLIB

dnl Checks for libraries.

dnl Checks for header files.
AC_CHECK_HEADER(/usr/include/libgen.h, libgen_header=, libgen_header=libgen.h)
AC_SUBST(libgen_header)
AC_CHECK_HEADER(/usr/include/stdint.h, stdint_header=, stdint_header=stdint.h)
AC_SUBST(stdint_header)

AC_CHECK_HEADER(/usr/include/syslog.h,
	AC_MSG_CHECKING([whether LOG_PERROR works])
	cat >conftest.$ac_ext <<EOF
	#include <syslog.h>
	main() {
		openlog("configure", LOG_PERROR, LOG_USER);
		syslog(LOG_DEBUG, "Hello, world");
		closelog();
	}
EOF
	if AC_TRY_EVAL(ac_link) && test -s conftest${ac_exeext} && ./conftest 2>&1 1>/dev/null | grep Hello >/dev/null
	then
		log_perror_works=yes
		syslog_header=
		syslog_object=
	else
		log_perror_works=no
		AC_DEFINE(LOG_PERROR_DOESNT_WORK)
	fi
	rm -fr conftest*
	AC_MSG_RESULT($log_perror_works)
)

AC_ARG_ENABLE(color, [])

if test x$log_perror_works = xyes && test x$enable_color = xno
then
	syslog_header=
	syslog_object=
else
	syslog_header=syslog.h
	syslog_object=syslog.o
fi

AC_SUBST(syslog_header)
AC_SUBST(syslog_object)

dnl Checks for typedefs, structures, and compiler characteristics.

dnl Checks for library functions.
AC_MSG_CHECKING([whether _POSIX_SEMAPHORES works])
AC_TRY_RUN(
#define _POSIX_C_SOURCE 199309L
#include <unistd.h>
#include <fcntl.h>
#include <semaphore.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>

int main() {
	int retVal;
	sem_t *sem;

	sem = sem_open("/foobar", O_CREAT, S_IRWXU, 0);
	if ((sem_t *) -1 == sem || NULL == sem) {
		retVal = EXIT_FAILURE;
	} else {
		retVal = EXIT_SUCCESS;
		sem_close(sem);
		sem_unlink("/foobar");
	}
	exit(retVal);
}
,
	AC_MSG_RESULT("yes")
	semaphore_header=
	semaphore_object=
,
	AC_MSG_RESULT("no")
	semaphore_header=semaphore.h
	semaphore_object=semaphore.o
)

AC_SUBST(semaphore_header)
AC_SUBST(semaphore_object)

AC_MSG_CHECKING([whether PTHREAD is final version])
AC_EGREP_CPP(
[#ERROR],
#include <unistd.h>
#if ( _POSIX_VERSION < 199506 )
#ERROR PTHREAD is draft 4
#endif
,
	AC_MSG_RESULT("no")
	pthread_header=pthread.h
	pthread_object=pthread.o
,
	AC_MSG_RESULT("yes")
	pthread_header=
	pthread_object=
)

AC_SUBST(pthread_header)
AC_SUBST(pthread_object)


AC_OUTPUT(Makefile examples/Makefile)
